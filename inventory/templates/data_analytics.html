{% extends "base.html" %}

{% block title %}
Top Medicine Sales
{% endblock title %}

{% block content %}
<div class="container my-4">
    <h1 class="text-center mb-4">Top Medicine Sales</h1>
    <p class="text-center">Analyze the best-selling medicines in the inventory.</p>

    <!-- Monthly Top Sales Chart -->
    <h2 class="mt-5">Monthly Medicine Demand</h2>
    <canvas id="monthlySalesChart" style="max-height: 500px;"></canvas>

    <!-- Top Medicine Demand -->
    <h2 class="mt-5">Top Medicine Demand</h2>
    <canvas id="salesChart" style="max-height: 400px;"></canvas>

    <!-- Top Medicines Table -->
    <h2 class="mt-5">Top Medicines Table</h2>
    {% if sales_data %}
    <table id="salesTable" class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Product</th>
                <th>Total Sales</th>
            </tr>
        </thead>
        <tbody>
            {% for item in sales_data %}
            <tr>
                <td>{{ item.product }}</td>
                <td>{{ item.total_sales }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No sales data available.</p>
    {% endif %}
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Initialize DataTables
    $(document).ready(function () {
        $('#salesTable').DataTable();
    });

    // Prepare data for Monthly Top Sales Chart
    const monthlySales = {% if monthly_sales %}{{ monthly_sales|safe }}{% else %}{} {% endif %};
    const months = Object.keys(monthlySales);
    const datasets = [];

    const productData = {};
    months.forEach(month => {
        monthlySales[month].forEach(item => {
            if (!productData[item.product]) {
                productData[item.product] = [];
            }
            productData[item.product].push({ month: month, sales: item.total_sales });
        });
    });

    for (const [product, data] of Object.entries(productData)) {
        datasets.push({
            label: product,
            data: months.map(month => {
                const record = data.find(item => item.month === month);
                return record ? record.sales : 0;
            }),
            borderWidth: 1,
            fill: false,
            tension: 0.4
        });
    }

    // Render the Monthly Top Sales Chart
    const ctxMonthly = document.getElementById('monthlySalesChart').getContext('2d');
    new Chart(ctxMonthly, {
        type: 'line',
        data: {
            labels: months,
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Top Sales by Month'
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Month'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Total Sales'
                    },
                    beginAtZero: true
                }
            }
        }
    });

    // Prepare data for Top Medicine Demand Chart
    const salesData = {% if sales_data %}{{ sales_data|safe }}{% else %}[] {% endif %};
    const labels = salesData.map(s => s.product);
    const sales = salesData.map(s => s.total_sales);

    // Render the Top Medicine Demand Chart
    const ctx = document.getElementById('salesChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Total Sales',
                    data: sales,
                    backgroundColor: 'rgba(75, 192, 192, 0.7)',
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
            },
            scales: {
                x: {
                    ticks: {
                        autoSkip: false,
                        maxRotation: 45,
                        minRotation: 0,
                    },
                },
            },
        }
    });
</script>

{% endblock content %}
