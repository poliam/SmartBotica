{% extends "base.html" %}

{% block title %}Demand Predictions{% endblock title %}

{% block content %}
<div class="container my-4">
    <h1 class="text-center mb-4">Demand Predictions</h1>

    <!-- Filter Section -->
    <div class="row mb-4">
        <label for="medicineFilter" class="col-form-label col-auto">Filter by Medicine:</label>
        <div class="col-auto">
            <select id="medicineFilter" class="form-select">
                <option value="">-- All Medicines --</option>
                {% for product in top_30_products %}
                <option value="{{ product }}" {% if selected_product == product %}selected{% endif %}>{{ product }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Chart Section -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Demand Prediction Chart</h5>
        </div>
        <div class="card-body">
            <canvas id="predictionChart" style="max-height: 400px;"></canvas>
        </div>
    </div>

    <!-- Collapsible Section for ADF Test Results -->
<div class="accordion mt-5" id="accordionADF">
    <div class="accordion-item">
        <h2 class="accordion-header" id="adfHeader">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#adfResults" aria-expanded="false" aria-controls="adfResults">
                ADF Test Results
            </button>
        </h2>
        <div id="adfResults" class="accordion-collapse collapse" aria-labelledby="adfHeader" data-bs-parent="#accordionADF">
            <div class="accordion-body table-responsive">
                {% if adf_results %}
                <table id="adfTable" class="table table-striped table-bordered table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>Product</th>
                            <th>ADF Statistic</th>
                            <th>p-value</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in adf_results %}
                        <tr>
                            <td>{{ result.product }}</td>
                            <td>{{ result.adf_statistic }}</td>
                            <td>{{ result.p_value }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>No ADF test results available due to insufficient data.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Collapsible Section for Predictions -->
<div class="accordion mt-5" id="accordionPredictions">
    <div class="accordion-item">
        <h2 class="accordion-header" id="predictionsHeader">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#predictions" aria-expanded="false" aria-controls="predictions">
                Predictions
            </button>
        </h2>
        <div id="predictions" class="accordion-collapse collapse" aria-labelledby="predictionsHeader" data-bs-parent="#accordionPredictions">
            <div class="accordion-body table-responsive">
                {% if predictions %}
                <table id="predictionsTable" class="table table-striped table-bordered table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>Product</th>
                            <th>Actual</th>
                            <th>Predicted</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for prediction in predictions %}
                        <tr data-product="{{ prediction.product }}">
                            <td>{{ prediction.product }}</td>
                            <td>{{ prediction.actual|join:", " }}</td>
                            <td>{{ prediction.predicted|join:", " }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>No predictions available due to insufficient data.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>



<!-- JavaScript for Chart.js and DataTables -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Initialize DataTables
    $(document).ready(function () {
        $('#adfTable').DataTable();
        $('#predictionsTable').DataTable();
    });

    // Prepare data for Chart.js
    const predictions = {% if predictions %}{{ predictions|safe }}{% else %}[]{% endif %};

    let filteredPredictions = predictions; // Filtered data for chart and table
    const selectedProduct = '{{ selected_product }}'; // Selected product for the filter

    // Filter predictions to match the selected product
    const filteredData = predictions.filter(p => !selectedProduct || p.product === selectedProduct);

    // Generate labels and data for the chart
    // Generate labels and data for the chart
    const labels = filteredData.length > 0 ? Array.from(
        { length: filteredData[0].actual.length + filteredData[0].predicted.length },
        (_, i) => {
            return i < filteredData[0].actual.length 
                ? `Week ${i + 1} (Actual)` 
                : `Week ${i + 1 - filteredData[0].actual.length} (Predicted)`;
        }
    ) : [];


    const actualData = filteredData.length > 0 ? filteredData[0].actual : [];
    const predictedData = filteredData.length > 0 ? filteredData[0].predicted : [];

    // Render Chart.js
    const ctx = document.getElementById('predictionChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line', // Line chart for time series
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Actual Sales',
                    data: actualData,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderWidth: 2,
                    tension: 0.3, // Smooth curves
                },
                {
                    label: 'Predicted Sales',
                    data: [...Array(actualData.length).fill(null), ...predictedData], // Append predicted data
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderDash: [5, 5], // Dashed line
                    borderWidth: 2,
                    tension: 0.3, // Smooth curves
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Time (Weeks)',
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Sales Quantity',
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function (tooltipItem) {
                            return `${tooltipItem.dataset.label}: ${tooltipItem.raw}`;
                        }
                    }
                }
            }
        }
    });

    // Apply the default "All Medicines" filter on page load
    document.addEventListener('DOMContentLoaded', function () {
        const filter = document.getElementById('medicineFilter');

        // Set the dropdown to the default "All Medicines"
        filter.value = ''; // Ensure the dropdown shows "-- All Medicines --"

        // Apply the filter to show all data
        applyFilter('');
    });

    // Filter Functionality
    document.getElementById('medicineFilter').addEventListener('change', function () {
        const selectedMedicine = this.value.toLowerCase();

        // Update table rows
        const rows = document.querySelectorAll('#predictionsTable tbody tr');
        rows.forEach(row => {
            const product = row.getAttribute('data-product').toLowerCase();
            if (!selectedMedicine || product.includes(selectedMedicine)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });

        // Update filtered data for chart
        if (selectedMedicine) {
            filteredPredictions = predictions.filter(p =>
                p.product.toLowerCase() === selectedMedicine
            );
        } else {
            filteredPredictions = predictions; // Reset to all data
        }

        // Update the chart with the filtered data
        updateChart(filteredPredictions);
    });

    // Helper function to update the chart with filtered data
    function updateChart(filteredData) {
        const labels = filteredData.length > 0 ? Array.from(
            { length: filteredData[0].actual.length + filteredData[0].predicted.length },
            (_, i) => {
                return i < filteredData[0].actual.length ? `Week ${i + 1} (Actual)` : `Week ${i + 1 - filteredData[0].actual.length} (Predicted)`;
            }
        ) : [];

        const actualData = filteredData.length > 0 ? filteredData[0].actual : [];
        const predictedData = filteredData.length > 0 ? filteredData[0].predicted : [];

        chart.data.labels = labels;
        chart.data.datasets[0].data = actualData;
        chart.data.datasets[1].data = [...Array(actualData.length).fill(null), ...predictedData];
        chart.update();
    }

    // Helper function to apply the filter
    function applyFilter(selectedMedicine) {
        const rows = document.querySelectorAll('#predictionsTable tbody tr');
        rows.forEach(row => {
            const product = row.getAttribute('data-product').toLowerCase();
            if (!selectedMedicine || product.includes(selectedMedicine)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });

        // Filter predictions for chart
        if (selectedMedicine) {
            filteredPredictions = predictions.filter(p =>
                p.product.toLowerCase() === selectedMedicine
            );
        } else {
            filteredPredictions = predictions; // Reset to all data
        }

        // Update the chart with filtered data
        updateChart(filteredPredictions);
    }
</script>

{% endblock content %}
