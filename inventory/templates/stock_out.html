{% extends "base.html" %}
{% load static %}

{% block title %}Manage Stock Out{% endblock title %}

{% block content %}
<div class="container my-5">
    <h1 class="text-center text-danger">Manage Stock Out</h1>

    <!-- Filter and Search -->
    <form method="get" action="{% url 'general-stock-out' %}">
        <div class="form-row align-items-center">
            <div class="col-md-4 position-relative">
                <input type="text" name="search" id="searchInput" class="form-control" placeholder="Search by name or brand" value="{{ search_query }}">
                <div id="suggestions" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
            </div>
            <div class="col-md-3 mb-2">
                <select name="category" class="form-control">
                    <option value="">All Categories</option>
                    {% if pharmacologic_categories %}
                        {% for category in pharmacologic_categories %}
                            <option value="{{ category.id }}" {% if selected_category == category.id|stringformat:"s" %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                        {% endfor %}
                    {% else %}
                        <option value="">No Categories Available</option>
                    {% endif %}
                </select>
            </div>
            <div class="col-md-2 mb-2">
                <label>
                    <input type="checkbox" name="expiring_soon" {% if expiring_soon_checked %}checked{% endif %}>
                    Expiring Soon
                </label>
            </div>
            <div class="col-md-2 mb-2">
                <button type="submit" class="btn btn-primary">Filter</button>
            </div>
        </div>
    </form>

    <!-- Stock Out Form -->
    <form method="post" action="{% url 'general-stock-out' %}">
        {% csrf_token %}
        <table class="table table-bordered table-hover text-center">
            <thead class="thead-dark">
                <tr>
                    <th>Select</th>
                    <th>Product Name</th>
                    <th>Brand Name</th>
                    <th>Dosage Strength</th>
                    <th>Form</th>
                    <th>Classification</th>
                    <th>Pharmacologic Category</th>
                    <th>Nearest Expiry Date</th>
                    <th>Available Quantity</th>
                    <th>Quantity to Stock Out</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                    <tr>
                        <td>
                            <input type="checkbox" name="selected_products" value="{{ product.item_no }}-{% if product.nearest_expiry_date %}{{ product.nearest_expiry_date|date:'Y-m-d' }}{% else %}N/A{% endif %}">
                        </td>
                        <td>{{ product.generic_name }}</td>
                        <td>{{ product.brand_name }}</td>
                        <td>{{ product.dosage_strength }}</td>
                        <td>{{ product.form.name }}</td>
                        <td>{{ product.classification }}</td>
                        <td>{{ product.pharmacologic_category.name }}</td>
                        <td>{{ product.nearest_expiry_date|date:"Y-m-d" }}</td>
                        <td>{{ product.quantity }}</td>
                        <td>
                            <input 
                                type="number" 
                                name="stock_out_quantity_{{ product.item_no }}" 
                                class="form-control" 
                                min="1" 
                                max="{{ product.quantity }}" 
                                disabled>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="10">No products available for stock out.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="text-right mt-4">
            <button type="submit" class="btn btn-danger">Confirm Stock Out</button>
        </div>
    </form>

    <!-- Pagination -->
    <div class="row mt-4">
        <div class="col-md-12 d-flex justify-content-center">
            {% if products.has_other_pages %}
            <nav aria-label="Page navigation">
                <ul class="pagination pagination-sm">
                    {% if products.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?search={{ request.GET.search }}&page=1" aria-label="First">&laquo;&laquo;</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?search={{ request.GET.search }}&page={{ products.previous_page_number }}" aria-label="Previous">&laquo;</a>
                    </li>
                    {% endif %}

                    {% for num in products.paginator.page_range %}
                    {% if products.number == num %}
                    <li class="page-item active" aria-current="page">
                        <span class="page-link">{{ num }}</span>
                    </li>
                    {% elif num > products.number|add:'-3' and num < products.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?search={{ request.GET.search }}&page={{ num }}">{{ num }}</a>
                    </li>
                    {% endif %}
                    {% endfor %}

                    {% if products.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?search={{ request.GET.search }}&page={{ products.next_page_number }}" aria-label="Next">&raquo;</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?search={{ request.GET.search }}&page={{ products.paginator.num_pages }}" aria-label="Last">&raquo;&raquo;</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $('input[type="checkbox"]').change(function () {
            const row = $(this).closest('tr');
            const quantityInput = row.find('input[type="number"]');
            if ($(this).is(':checked')) {
                quantityInput.prop('disabled', false).prop('required', true);
            } else {
                quantityInput.prop('disabled', true).prop('required', false).val('');
            }
        });

        $('form').on('submit', function () {
            $('input[type="number"]').prop('disabled', false);
        });

        $('#searchInput').on('input', function () {
            const query = $(this).val();
            if (query.length > 1) {
                $.ajax({
                    url: "{% url 'stock-suggestions' %}",
                    data: { q: query },
                    success: function (data) {
                        $('#suggestions').empty();
                        if (data.suggestions.length > 0) {
                            data.suggestions.forEach(item => {
                                const suggestionText = `${item.generic_name} (${item.brand_name}) - ${item.dosage_strength || 'N/A'} [${item.form__name || 'N/A'}]`;
                                $('#suggestions').append(`<a href="#" class="list-group-item list-group-item-action">${suggestionText}</a>`);
                            });
                        } else {
                            $('#suggestions').append('<p class="list-group-item">No matches found</p>');
                        }
                    }
                });
            } else {
                $('#suggestions').empty();
            }
        });

        $(document).click(function (e) {
            if (!$(e.target).closest('#searchInput').length) {
                $('#suggestions').empty();
            }
        });
    });
</script>

{% endblock content %}