{% extends "base.html" %}
{% load static %}

{% block title %}Manage Stock Out{% endblock title %}

{% block content %}
<div class="container my-5">
    <div class="d-flex justify-content-center align-items-center mb-4">
        <h1 class="text-danger text-center">Manage Stock Out</h1>
    </div>
   

    <!-- Filter and Search -->
    <form method="get" action="{% url 'general-stock-out' %}" id="searchForm">
        <div class="form-row align-items-center">
            <!-- Search Input -->
            <div class="col-md-4 position-relative">
                <input type="text" name="search" id="searchInput" class="form-control" 
                       placeholder="Search by name or brand" value="{{ search_query }}">
                <div id="suggestions" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
            </div>
            <div class="col-md-2 mb-2">
                <label>
                    <input type="checkbox" name="expiring_soon" {% if expiring_soon_checked %}checked{% endif %}>
                    Expiring Soon
                </label>
            </div>
            <div class="col-md-2 mb-2">
            </div>
        </div>
    </form>
    
    

    <!-- Stock Out Form -->
    <form method="post" action="{% url 'general-stock-out' %}">
        {% csrf_token %}
        <table class="table table-bordered table-hover text-center">
            <thead class="thead-dark">
                <tr>
                    <th>Select</th>
                    <th>Product Name</th>
                    <th>Brand Name</th>
                    <th>Dosage Strength</th>
                    <th>Form</th>
                    <th>Classification</th>
                    <th>Pharmacologic Category</th>
                    <th>Nearest Expiry Date</th>
                    <th>Available Quantity</th>
                    <th>Quantity to Stock Out</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                    <tr>
                        <td>
                            <input type="checkbox" name="selected_products" value="{{ product.item_no }}-{% if product.nearest_expiry_date %}{{ product.nearest_expiry_date|date:'Y-m-d' }}{% else %}N/A{% endif %}">
                        </td>
                        <td>{{ product.generic_name }}</td>
                        <td>{{ product.brand_name }}</td>
                        <td>{{ product.dosage_strength }}</td>
                        <td>{{ product.form.name }}</td>
                        <td>{{ product.classification }}</td>
                        <td>{{ product.pharmacologic_category.name }}</td>
                        <td>{{ product.nearest_expiry_date|date:"Y-m-d" }}</td>
                        <td>{{ product.quantity }}</td>
                        <td>
                            <input 
                                type="number" 
                                name="stock_out_quantity_{{ product.item_no }}" 
                                class="form-control" 
                                min="1" 
                                max="{{ product.quantity }}" 
                                disabled>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="10">No products available for stock out.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="d-flex justify-content-between align-items-center mt-4">
            <!-- Back to Inventory Button -->
            <div class="align-self-start">
                <a href="{% url 'inventory' %}" class="btn btn-secondary">Back to Inventory</a>
            </div>
        
            <!-- Confirm Stock Out Button -->
            <div class="align-self-end">
                <button type="submit" class="btn btn-danger">Confirm Stock Out</button>
            </div>
        </div>
        
    </form>

    <!-- Pagination -->
    <div class="row mt-4">
        <div class="col-md-12 d-flex justify-content-center">
            {% if products.has_other_pages %}
            <nav aria-label="Page navigation">
                <ul class="pagination pagination-sm">
                    {% if products.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?search={{ request.GET.search }}&page=1" aria-label="First">&laquo;&laquo;</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?search={{ request.GET.search }}&page={{ products.previous_page_number }}" aria-label="Previous">&laquo;</a>
                    </li>
                    {% endif %}

                    {% for num in products.paginator.page_range %}
                    {% if products.number == num %}
                    <li class="page-item active" aria-current="page">
                        <span class="page-link">{{ num }}</span>
                    </li>
                    {% elif num > products.number|add:'-3' and num < products.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?search={{ request.GET.search }}&page={{ num }}">{{ num }}</a>
                    </li>
                    {% endif %}
                    {% endfor %}

                    {% if products.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?search={{ request.GET.search }}&page={{ products.next_page_number }}" aria-label="Next">&raquo;</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?search={{ request.GET.search }}&page={{ products.paginator.num_pages }}" aria-label="Last">&raquo;</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
    // Enable/disable quantity input based on checkbox
    $('input[type="checkbox"]').change(function () {
        const row = $(this).closest('tr');
        const quantityInput = row.find('input[type="number"]');
        if ($(this).is(':checked')) {
            quantityInput.prop('disabled', false).prop('required', true);
        } else {
            quantityInput.prop('disabled', true).prop('required', false).val('');
        }
    });

    // Enable disabled inputs before form submission
    $('form').on('submit', function () {
        $('input[type="number"]').prop('disabled', false);
    });

    // Search suggestions for products
    $('#searchInput').on('input', function () {
        const query = $(this).val();
        if (query.length > 1) {
            $.ajax({
                url: "{% url 'stock-suggestions' %}", // Ensure this URL is correct in your views
                data: { q: query },
                success: function (data) {
                    $('#suggestions').empty();
                    if (data.suggestions.length > 0) {
                        data.suggestions.forEach(item => {
                            const suggestionText = `${item.generic_name} (${item.brand_name}) - ${item.dosage_strength || 'N/A'} [${item.form__name || 'N/A'}]`;
                            const suggestionLink = `{% url 'view-stock-out' 0 %}`.replace('0', item.pk);
                            $('#suggestions').append(`
                                <a href="${suggestionLink}" class="list-group-item list-group-item-action suggestion-item">
                                    ${suggestionText}
                                </a>
                            `);
                        });
                    } else {
                        $('#suggestions').append('<p class="list-group-item">No matches found</p>');
                    }
                },
                error: function () {
                    $('#suggestions').empty().append('<p class="list-group-item">Error fetching suggestions</p>');
                }
            });
        } else {
            $('#suggestions').empty();
        }
    });

    // Hide suggestions when clicking outside the search input
    $(document).click(function (e) {
        if (!$(e.target).closest('#searchInput').length) {
            $('#suggestions').empty();
        }
    });

    // Ensure the form submits on Enter
    // Ensure the form submits on Enter
$('#searchInput').on('keypress', function (e) {
    if (e.key === 'Enter') {
        // Let the browser handle the form submission
    }
});

});


</script>   


{% endblock content %}